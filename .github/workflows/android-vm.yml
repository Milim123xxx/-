name: Android Cloud VM

on:
  workflow_dispatch:

jobs:
  run-android:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: 🧰 Install QEMU
        run: |
          sudo apt update
          sudo apt install -y qemu-kvm wget unzip curl

      - name: 📥 Download Android ISO
        run: |
          wget -O android.iso "https://www.dropbox.com/scl/fi/eh56gj9s3p4bsunciu3c2/android-x86_64-9.0-r2.iso?rlkey=kkuy6bqixv5cpumjbbxlgq3td&st=p7oumbo2&dl=1"

      - name: 💾 Create disk
        run: qemu-img create -f qcow2 android.qcow2 8G

      - name: 🚀 Start Android VM
        run: |
          nohup qemu-system-x86_64 \
            -m 2048 -smp 2 \
            -cdrom android.iso \
            -hda android.qcow2 \
            -boot d \
            -vnc :1 \
            -net nic -net user \
            -enable-kvm \
            -cpu host \
            -name "Android Cloud VM" &

      - name: 🌐 Expose port with ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok -y

          ngrok config add-authtoken ${{ secrets.NGROK_TOKEN }}
          nohup ngrok tcp 5901 --region=ap > ngrok.log &
          sleep 10
          cat ngrok.log | grep "url="
